<?php
require_once __DIR__ . '/../../bootstrap.php';

use App\Core\Database;

/*
|--------------------------------------------------------------------------
| 僅允許 POST 登出
|--------------------------------------------------------------------------
*/
if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    http_response_code(405);
    exit('Method Not Allowed');
}

/*
|--------------------------------------------------------------------------
| 啟動 Session
|--------------------------------------------------------------------------
*/
if (session_status() !== PHP_SESSION_ACTIVE) {
    session_start();
}

/*
|--------------------------------------------------------------------------
| 1️⃣ 刪除 Remember Me Token（DB）
|--------------------------------------------------------------------------
*/
if (!empty($_COOKIE['remember_token'])) {

    $token = $_COOKIE['remember_token'];
    $tokenHash = hash('sha256', $token);

    $pdo = Database::getInstance();
    $stmt = $pdo->prepare(
        "DELETE FROM remember_tokens
         WHERE token_hash = :hash"
    );
    $stmt->execute([
        'hash' => $tokenHash
    ]);
}

/*
|--------------------------------------------------------------------------
| 2️⃣ 清除 Remember Me Cookie
|--------------------------------------------------------------------------
*/
setcookie(
    'remember_token',
    '',
    [
        'expires'  => time() - 3600,
        'path'     => '/',
        'httponly' => true,
        'secure'   => false, // HTTPS 才 true
        'samesite' => 'Lax'
    ]
);

/*
|--------------------------------------------------------------------------
| 3️⃣ 清除 Session
|--------------------------------------------------------------------------
*/
$_SESSION = [];

/*
|--------------------------------------------------------------------------
| 4️⃣ 銷毀 Session
|--------------------------------------------------------------------------
*/
session_destroy();

/*
|--------------------------------------------------------------------------
| 5️⃣ 換 Session ID（保險）
|--------------------------------------------------------------------------
*/
session_regenerate_id(true);

/*
|--------------------------------------------------------------------------
| 6️⃣ 導向登入頁
|--------------------------------------------------------------------------
*/
header('Location: ' . $config['routes']['login']);
exit;
